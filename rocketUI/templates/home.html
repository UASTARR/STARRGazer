<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Enhanced Dashboard</title>
<script src="static/chart.umd.js"></script>


<!--  Adding video display, map display
Responsive Design

bug: when map and two other tabs - when menu close button is pressed the map tab closes while the two other tabs stay open
when menu button is pressed again (to open menu) the map and the two other tabs show up
-->

<style>
  * { box-sizing: border-box; }
  body, html { margin: 0; padding: 0; height: 100%; font-family: "Lato", sans-serif; }

  header {
    width: 100%; height: 80px; background-color: #333; color: white;
    font-size: 28px; display: flex; align-items: center; justify-content: center;
    position: fixed; top: 0; left: 0; z-index: 1200;
  }

  /* Menu Toggle Button */
  #menuToggle {
    position: absolute;
    right: 15px;
    background: #444;
    color: white;
    border: none;
    padding: 8px 12px;
    font-size: 20px;
    cursor: pointer;
    border-radius: 4px;
  }

  #menuToggle:hover {
    background: #666;
  }

  /*Sidebar Tabs */
  .tab {
    position: fixed; top: 80px; right: 0; width: 20%; height: calc(100% - 80px);
    background-color: #f1f1f1; border-left: 1px solid #ccc; overflow-y: auto; z-index: 1100;
  }

  /*Hide sidebar when collapsed*/
  .menu-collapsed .tab {
    display: none;
  }

  .menu-collapsed #placeholder,
  .menu-collapsed .tabcontent {
    width: 100% !important;
    left: 0 !important;
  }

  .tab button {
    display: block; background-color: inherit; color: black;
    padding: 18px 12px; width: 100%; border: none; outline: none;
    text-align: left; cursor: pointer; transition: 0.12s; font-size: 16px;
  }
  .tab button:hover { background-color: #ddd; }
  .tab button.active { background-color: #ccc; }

  #placeholder {
    display: flex; justify-content: center; align-items: center;
    position: fixed; top: 80px; left: 0; width: 80%; height: calc(100% - 80px);
    background-color: #cce6ff; font-size: 22px; color: #333; z-index: 100;
  }

  .tabcontent {
    display: none; position: absolute; background-color: #fff;
    border: 1px solid #ccc; border-radius: 6px; overflow: auto;
    padding: 12px; box-shadow: 0 6px 18px rgba(0,0,0,0.12);
  }

  #Map { z-index: 200; background-color: #fff; pointer-events: auto; }
  .tabcontent:not(#Map) { z-index: 400; pointer-events: auto; }

  .tab-header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 8px; border-bottom: 1px solid #eee; padding-bottom: 6px;
  }

  .close-btn {
    font-size: 22px; font-weight: bold; background: none; border: none;
    cursor: pointer; color: #777; line-height: 1; padding: 0 6px;
  }
  .close-btn:hover { color: #000; }

  .graph-container {
    width: 100%; height: calc(100% - 60px); position: relative;
  }

  @media (max-width: 800px) {
    .tab { width: 25%; }
    #placeholder { width: 75%; }
  }
</style>
</head>
<body>

<header>
  <button id="menuToggle" onclick="toggleMenu()">☰</button>
  STARR Alberio
</header>

<div class="tab">
  <button class="tablinks" onclick="openTab(event,'Altitude')">Altitude</button>
  <button class="tablinks" onclick="openTab(event,'GPS')">GPS</button>
  <button class="tablinks" onclick="openTab(event,'GroundSpeed')">Ground Speed</button>
  <button class="tablinks" onclick="openTab(event,'Gyro')">Gyro</button>
  <button class="tablinks" onclick="openTab(event,'Map')">Map</button>
  <button class="tablinks" onclick="openTab(event,'Pressure')">Pressure</button>
  <button class="tablinks" onclick="openTab(event,'Temperature')">Temperature</button>
  <button class="tablinks" onclick="openTab(event,'Video Display')">Video Display</button>
</div>

<div id="placeholder">Select a tab to view data</div>

<!-- Tabs -->
<div id="Altitude" class="tabcontent">
  <div class="tab-header"><h3>Altitude</h3><button class="close-btn" onclick="closeTab('Altitude')">×</button></div>
  <div class="graph-container"><canvas id="altitudeChart"></canvas></div>
</div>

<div id="GPS" class="tabcontent">
  <div class="tab-header"><h3>GPS</h3><button class="close-btn" onclick="closeTab('GPS')">×</button></div>
  <p id="gpsData">Latitude / Longitude will appear here</p>
</div>

<div id="GroundSpeed" class="tabcontent">
  <div class="tab-header"><h3>Ground Speed</h3><button class="close-btn" onclick="closeTab('GroundSpeed')">×</button></div>
  <div class="graph-container"><canvas id="groundSpeedChart"></canvas></div>
</div>

<div id="Gyro" class="tabcontent">
  <div class="tab-header"><h3>Gyro</h3><button class="close-btn" onclick="closeTab('Gyro')">×</button></div>
  <div class="graph-container"><canvas id="gyroChart"></canvas></div>
</div>

<div id="Map" class="tabcontent">
  <div class="tab-header"><h3>Map</h3><button class="close-btn" onclick="closeTab('Map')">×</button></div>
  <p>Map visualization placeholder</p>
</div>

<div id="Pressure" class="tabcontent">
  <div class="tab-header"><h3>Pressure</h3><button class="close-btn" onclick="closeTab('Pressure')">×</button></div>
  <div class="graph-container"><canvas id="pressureChart"></canvas></div>
</div>

<div id="Temperature" class="tabcontent">
  <div class="tab-header"><h3>Temperature</h3><button class="close-btn" onclick="closeTab('Temperature')">×</button></div>
  <div class="graph-container"><canvas id="temperatureChart"></canvas></div>
</div>

<div id="Video Display" class="tabcontent">
  <div class="tab-header"><h3>Video Display</h3><button class="close-btn" onclick="closeTab('Video Display')">×</button></div>
  <p>Video Display placeholder</p>
</div>

<script>
/*MENU COLLAPSING*/
let menuOpen = true;

function toggleMenu() {
  menuOpen = !menuOpen;

  if (!menuOpen) {
    document.body.classList.add("menu-collapsed");
  } else {
    document.body.classList.remove("menu-collapsed");
  }

  layoutTabs();
}


/*telemetry and chart code*/
const TIME_WINDOW = 15;
let tabQueue = [];
const MAX_TABS = 2;
const HEADER_H = 80;

let charts = {}; // store all Chart.js instances

// Initialize empty charts
function initCharts() {
  const commonOpts = {responsive:true, maintainAspectRatio:false, animation:{duration:0}, scales:{x:{title:{display:true,text:'Time (s)'}}, y:{title:{display:true}}}};
  
  charts.temperatureChart = new Chart(document.getElementById('temperatureChart').getContext('2d'), {
    type:'line', data:{labels:[], datasets:[{label:'Temp (°C)', data:[], borderColor:'red', backgroundColor:'rgba(255,0,0,0.1)', tension:0.4, fill:true}]}, options:{...commonOpts, scales:{...commonOpts.scales, y:{min:15,max:35,title:{display:true,text:'°C'}}}}
  });
  
  charts.altitudeChart = new Chart(document.getElementById('altitudeChart').getContext('2d'), {
    type:'line', data:{labels:[], datasets:[{label:'Altitude (m)', data:[], borderColor:'blue', backgroundColor:'rgba(0,0,255,0.1)', tension:0.4, fill:true}]}, options:{...commonOpts, scales:{...commonOpts.scales, y:{min:100,max:150,title:{display:true,text:'m'}}}}
  });
  
  charts.groundSpeedChart = new Chart(document.getElementById('groundSpeedChart').getContext('2d'), {
    type:'line', data:{labels:[], datasets:[{label:'Speed (m/s)', data:[], borderColor:'green', backgroundColor:'rgba(0,255,0,0.1)', tension:0.4, fill:true}]}, options:{...commonOpts, scales:{...commonOpts.scales, y:{min:0,max:20,title:{display:true,text:'m/s'}}}}
  });
  
  charts.pressureChart = new Chart(document.getElementById('pressureChart').getContext('2d'), {
    type:'line', data:{labels:[], datasets:[{label:'Pressure (hPa)', data:[], borderColor:'purple', backgroundColor:'rgba(128,0,128,0.1)', tension:0.4, fill:true}]}, options:{...commonOpts, scales:{...commonOpts.scales, y:{min:1010,max:1020,title:{display:true,text:'hPa'}}}}
  });
  
  charts.gyroChart = new Chart(document.getElementById('gyroChart').getContext('2d'), {
    type:'line', data:{labels:[], datasets:[
      {label:'Roll (°)', data:[], borderColor:'red', fill:false},
      {label:'Pitch (°)', data:[], borderColor:'blue', fill:false},
      {label:'Yaw (°)', data:[], borderColor:'green', fill:false}
    ]}, options:{...commonOpts, scales:{...commonOpts.scales, y:{min:-60,max:60,title:{display:true,text:'°'}}}}
  });
}

// Fetch telemetry from Python server
async function fetchTelemetry() {
  try {
    const res = await fetch("http://127.0.0.1:5000/telemetry");
    return await res.json();
  } catch(err) {
    console.error("Fetch failed", err);
  }
}

// Update all charts and GPS
async function updateCharts() {
  const data = await fetchTelemetry();
  if (!data) return;

  const time = data.time;

  function pushData(chart, value) {
    chart.data.labels.push(time);
    chart.data.datasets[0].data.push(value);
    if(chart.data.labels.length>TIME_WINDOW) {
      chart.data.labels.shift();
      chart.data.datasets[0].data.shift();
    }
    chart.update("none");
  }

  pushData(charts.temperatureChart, data.temperature);
  pushData(charts.altitudeChart, data.altitude);
  pushData(charts.groundSpeedChart, data.ground_speed);
  pushData(charts.pressureChart, data.pressure);

  // Gyro
  const gyro = data.gyro;
  const gChart = charts.gyroChart;
  gChart.data.labels.push(time);
  ['roll','pitch','yaw'].forEach((axis,i)=> {
    gChart.data.datasets[i].data.push(gyro[i]);
    if(gChart.data.labels.length>TIME_WINDOW){
      gChart.data.datasets[i].data.shift();
    }
  });
  if(gChart.data.labels.length>TIME_WINDOW) gChart.data.labels.shift();
  gChart.update("none");

  // GPS
  document.getElementById("gpsData").textContent = `Lat: ${data.gps[0]} / Lon: ${data.gps[1]}`;
}

// Tab handling
let interval = null;
function openTab(evt, tabName) {
  if(!charts.temperatureChart) initCharts();

  if(tabQueue.includes(tabName)) tabQueue = [tabName, ...tabQueue.filter(t=>t!==tabName)];
  else {
    if(tabName!=='Map' && tabQueue.filter(t=>t!=='Map').length>=MAX_TABS) closeTab(tabQueue.pop(),true);
    tabQueue.unshift(tabName);
  }
  layoutTabs();
  activateTab(tabName);
  if(!interval) interval = setInterval(updateCharts,1000);
}

function closeTab(tabName, internal=false) {
  tabQueue = tabQueue.filter(t=>t!==tabName);
  const el = document.getElementById(tabName);
  if(el) el.style.display='none';
  document.querySelectorAll('.tablinks').forEach(b=>b.classList.remove('active'));
  layoutTabs();
}

function layoutTabs(){
  document.querySelectorAll('.tabcontent').forEach(t=>t.style.display='none');
  const hasMap = tabQueue.includes('Map');
  const nonMap = tabQueue.filter(t=>t!=='Map');
  const availH = `calc(100% - ${HEADER_H}px)`;
  const halfH = `calc((${availH}) / 2)`;
  const fullW = '80%';
  const leftHalf = '50%';

  if(hasMap && nonMap.length===0){
    const mapEl=document.getElementById('Map');
    mapEl.style.display='block';
    mapEl.style.position='absolute'; mapEl.style.left='0'; mapEl.style.top=`${HEADER_H}px`;
    mapEl.style.width=fullW; mapEl.style.height=availH; mapEl.style.zIndex=200;
  } else if(hasMap){
    const mapEl=document.getElementById('Map');
    mapEl.style.display='block';
    mapEl.style.position='absolute'; mapEl.style.left='0'; mapEl.style.top=`${HEADER_H}px`;
    mapEl.style.width=leftHalf; mapEl.style.height=availH; mapEl.style.zIndex=200;
    nonMap.slice(0,MAX_TABS).forEach((name,idx)=>{
      const el=document.getElementById(name);
      if(!el) return;
      el.style.display='block'; el.style.position='absolute'; el.style.left=leftHalf;
      el.style.width=`calc(${fullW} - ${leftHalf})`;
      el.style.top=`calc(${HEADER_H}px + ${idx}*${halfH})`;
      el.style.height=halfH; el.style.zIndex=400;
    });
  } else{
    nonMap.slice(0,MAX_TABS).forEach((name,idx)=>{
      const el=document.getElementById(name);
      if(!el) return;
      el.style.display='block'; el.style.position='absolute'; el.style.left='0';
      el.style.width=fullW; el.style.top=`calc(${HEADER_H}px + ${idx}*${halfH})`;
      el.style.height=halfH; el.style.zIndex=400;
    });
  }

  document.getElementById('placeholder').style.display=tabQueue.length===0?'flex':'none';
}

function activateTab(tabName){
  document.querySelectorAll('.tablinks').forEach(b=>b.classList.remove('active'));
  const b=document.querySelector(`button[onclick*="${tabName}"]`);
  if(b) b.classList.add('active');
}

// Start clean
window.addEventListener('load',()=>{document.querySelectorAll('.tabcontent').forEach(t=>t.style.display='none'); document.getElementById('placeholder').style.display='flex'; tabQueue=[];});
</script>

</body>
</html>
